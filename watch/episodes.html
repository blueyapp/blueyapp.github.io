<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Watch Bluey!</title>
      <meta name="title" content="Watch Bluey!" />
      <meta name="description" content="Bluey is an inexhaustible six year-old Blue Heeler dog, who loves to play and turns everyday family life into extraordinary adventures, developing her imagination as well as her mental, physical and emotional resilience." />
      <meta name="keywords" content="bluey, children's show, family entertainment" />
      <meta name="robots" content="index, follow" />
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
      <meta name="language" content="English" />
      <meta name="author" content="Bluey Heeler" />
      <meta property="og:title" content="Watch Bluey!" />
      <meta property="og:description" content="Bluey is an inexhaustible six year-old Blue Heeler dog, who loves to play and turns everyday family life into extraordinary adventures, developing her imagination as well as her mental, physical and emotional resilience." />
      <meta property="og:image" content="https://cdn.iview.abc.net.au/thumbs/1200/ch/CH2003Q_66399c133e743_1920.jpg" />
      <meta property="og:url" content="https://pages.blueynet.org/watch/episodes" />
      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:title" content="Watch Bluey!" />
      <meta name="twitter:description" content="Bluey is an inexhaustible six year-old Blue Heeler dog, who loves to play and turns everyday family life into extraordinary adventures, developing her imagination as well as her mental, physical and emotional resilience." />
      <meta name="twitter:image" content="https://cdn.iview.abc.net.au/thumbs/1200/ch/CH2003Q_66399c133e743_1920.jpg" />
      <link rel="icon" href="/bluey-star.ico" type="image/x-icon" />
      <link href="https://vjs.zencdn.net/7.15.4/video-js.css" rel="stylesheet" />
      <link href="/fonts/HelloHeadline.css" rel="stylesheet" type="text/css" />
      <style>
         * {
         	box-sizing: border-box;
         	margin: 0;
         	padding: 0;
         }
         
         body {
         	font-family: "Hello Headline", Arial, sans-serif !important;
         	background-color: #87c0e8 !important;
         	transition: background 0.3s, color 0.3s;
         }
         
         .container {
         	max-width: 1200px;
         	margin: 0 auto;
         	padding: 20px;
         }
         
         .header {
         	display: flex;
         	align-items: center;
         	justify-content: space-between;
         }
         
         .logo {
         	width: 150px;
         	border-radius: 0px;
         }
         
         .nav {
         	display: flex;
         	list-style: none;
         }
         
         .nav li {
         	margin-left: 20px;
         	display: flex;
         	align-items: center;
         }
         
         .nav a {
         	text-decoration: none;
         	color: #ffffff;
         	font-weight: bold;
         }
         
         .main {
         	display: flex;
         	gap: 45px;
         	margin-top: 30px;
         }
         
         .main-left,
         .main-right {
         	flex: 1;
         }
         
         .player-wrapper {
         	display: none;
         	width: 100%;
         	margin: 0 auto;
         	box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
         }
         
         #player {
         	width: 100%;
         	height: auto;
         	background-color: #000;
         }
         
         #content {
         	margin-top: 10px;
         	position: relative;
         }
         
         #seasons-container {
         	display: flex;
         	margin: 0 auto;
         	justify-content: space-between;
         	padding: 10px 0;
         	background-color: #87c0e8;
         	text-align: center;
         	max-width: 700px;
         	flex-wrap: wrap;
         }
         
         .season-selector__button {
         	margin: 5px;
         	cursor: pointer;
         	color: #ffffff;
         	border: none;
         	background-color: transparent;
         	padding: 10px 10px;
         	border-radius: 5px;
         	font-family: 'Hello Headline', sans-serif;
         }
         
         .season-selector__button.selected {
         	color: #000000;
         	background-color: #ffffff;
         }
         
         #info-button {
         	margin: 5px;
         	cursor: pointer;
         	color: #ffffff;
         	background-color: #edcc6f;
         	padding: 10px 10px;
         	border: none;
         	border-radius: 5px;
         	font-family: 'Hello Headline', sans-serif;
         }
         
         #shuffle-button {
         	margin: 5px;
         	cursor: pointer;
         	background: none;
         	border: none;
         	padding: 0;
         }
         /* --- Shuffle icon color (SVG) --- */
         
         #shuffle-icon {
         	color: #fff;
         	/* White in light mode */
         	background: transparent;
         	border-radius: 8px;
         	transition: color 0.2s, background 0.2s, box-shadow 0.2s;
         }
         
         body.dark #shuffle-icon {
         	color: #fbbf24;
         	/* Gold in dark mode */
         	background: #191d25;
         }
         
         #shuffle-icon.active {
         	color: #23293a !important;
         	background: #ffe066 !important;
         	box-shadow: 0 0 8px 2px #ffe066;
         }
         
         body.dark #shuffle-icon.active {
         	color: #23293a !important;
         	background: #ffe066 !important;
         	box-shadow: 0 0 8px 2px #ffe066;
         }
         
         #episodes {
         	overflow-y: scroll;
         	scrollbar-width: thin;
         	scrollbar-color: transparent transparent;
         	max-height: 500px;
         	max-width: 700px;
         	padding: 5px 0;
         	background-color: #87c0e8;
         	margin: 0 auto;
         }
         
         #episodes::-webkit-scrollbar {
         	width: 6px;
         }
         
         #episodes::-webkit-scrollbar-thumb {
         	background-color: transparent;
         }
         
         #episodes li {
         	margin: 5px;
         	list-style-type: none;
         	cursor: pointer;
         	border: 1px solid #dee2e6;
         	border-radius: 5px;
         	padding: 10px;
         	color: #fff;
         	background-color: #404066;
         	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
         	display: flex;
         	align-items: flex-start;
         }
         
         #episodes img {
         	margin-right: 15px;
         	display: block;
         	width: 100px;
         	height: auto;
         	max-width: 100%;
         	max-height: 90px;
         	object-fit: cover;
         }
         
         #episodes li div {
         	flex: 1;
         	text-align: left;
         }
         
         #episodes h2 {
         	font-size: 20px;
         	font-weight: bold;
         	margin: 0;
         }
         
         #episodes p {
         	font-size: 12px;
         	margin: 0;
         }
         
         #episodes li.selected {
         	background-color: #ffffff;
         	color: #000000;
         }
         
         .overlay {
         	display: none;
         	position: absolute;
         	top: 50%;
         	left: 50%;
         	transform: translate(-50%, -50%);
         	width: 100%;
         	height: 100%;
         	background-color: rgba(0, 0, 0, 0.8);
         	z-index: 1;
         	overflow: hidden;
         	border-radius: 10px;
         }
         
         .overlay-content {
         	text-align: left;
         	color: #fff;
         	padding: 20px;
         	display: flex;
         	align-items: center;
         }
         
         .overlay img {
         	max-width: 50%;
         	margin-right: 15px;
         	height: auto;
         	max-height: 200px;
         	border-radius: 5px;
         }
         
         .close-overlay {
         	position: absolute;
         	top: 10px;
         	right: 10px;
         	cursor: pointer;
         	color: #fff;
         	font-size: 20px;
         }
         
         .overlay-content-text {
         	flex: 1;
         }
         
         #overlay-title {
         	margin-bottom: 10px;
         }
         
         #download-button {
         	margin-top: 10px;
         	cursor: pointer;
         	color: #ffffff;
         	background-color: #e2793b;
         	padding: 10px 20px;
         	border: none;
         	border-radius: 5px;
         	font-family: 'Hello Headline', sans-serif;
         }
         
         .bmpui-ui-watermark {
         	display: none;
         }
         
         .donate {
         	align-items: center;
         }
         
         #language-select {
         	margin: 5px;
         	cursor: pointer;
         	color: #ffffff;
         	background-color: #404066;
         	padding: 10px;
         	border: none;
         	border-radius: 5px;
         	font-family: 'Hello Headline', sans-serif;
         	appearance: none;
         	-webkit-appearance: none;
         	-moz-appearance: none;
         }
         
         #language-select option {
         	color: #000000;
         	background-color: #ffffff;
         }
         
         @media (orientation: portrait) {
         	.header {
         		flex-direction: column;
         	}
         	.nav {
         		margin-top: 20px;
         	}
         	.main {
         		flex-direction: column;
         		gap: 20px;
         	}
         	.main-left,
         	.main-right {
         		width: 100%;
         	}
         	.overlay-content {
         		text-align: center;
         		color: #fff;
         		padding: 20px;
         		display: flex;
         		flex-direction: column;
         		align-items: center;
         	}
         	.overlay-content-text {
         		flex: 1;
         		padding: 20px;
         	}
         	#download-button {
         		margin-top: 10px;
         		cursor: pointer;
         		color: #ffffff;
         		background-color: #e2793b;
         		padding: 10px 20px;
         		border: none;
         		border-radius: 5px;
         		font-family: 'Hello Headline', sans-serif;
         	}
         	#seasons-container {
         		flex-direction: column;
         		align-items: center;
         	}
         }
         
         @media (orientation: landscape) {
         	.player-wrapper {
         		margin-top: 25px;
         	}
         	.overlay {
         		display: none !important;
         	}
         	#info-button {
         		display: none;
         	}
         }
         /* --- Dark mode styles --- */
         
         body.dark {
         	background: #191d25 !important;
         	color: #dbeafe !important;
         }
         
         body.dark .header {
         	background: #191d25 !important;
         }
         
         body.dark .nav a {
         	color: #fbbf24 !important;
         }
         
         body.dark .main {
         	background: none !important;
         }
         
         body.dark #seasons-container {
         	background: #191d25 !important;
         }
         
         body.dark .season-selector__button {
         	color: #fbbf24;
         	background: #191d25;
         }
         
         body.dark .season-selector__button.selected {
         	color: #23293a;
         	background: #fbbf24;
         }
         
         body.dark #episodes {
         	background: #191d25 !important;
         }
         
         body.dark #episodes li {
         	background: #32436a !important;
         	color: #fbbf24 !important;
         	border-color: #394867;
         }
         
         body.dark #episodes li.selected {
         	background: #fbbf24 !important;
         	color: #23293a !important;
         }
         
         body.dark .overlay {
         	background: rgba(0, 0, 0, 0.92);
         }
         
         body.dark .overlay-content {
         	color: #fbbf24;
         }
         
         body.dark #download-button,
         body.dark #download-button-landscape {
         	background: #394867 !important;
         	color: #ffd700 !important;
         }
         
         body.dark #language-select {
         	background: #394867;
         	color: #fbbf24;
         }
         /* --- Dark mode toggle button --- */
         
         .darkmode-toggle {
         	background: none;
         	border: none;
         	cursor: pointer;
         	border-radius: 50%;
         	margin-left: 8px;
         	width: 36px;
         	height: 36px;
         	display: flex;
         	align-items: center;
         	justify-content: center;
         	outline: none;
         	padding: 2px;
         	transition: background 0.2s;
         }
         
         .darkmode-toggle:focus,
         .darkmode-toggle:hover {
         	background: rgba(128, 128, 128, 0.12);
         }
         
         .darkmode-toggle svg {
         	width: 24px;
         	height: 24px;
         	display: block;
         	pointer-events: none;
         }
         
         .dark .darkmode-toggle .sun {
         	display: none;
         }
         
         .dark .darkmode-toggle .moon {
         	display: block;
         }
         
         .darkmode-toggle .moon {
         	display: none;
         }
         
         .darkmode-toggle .sun {
         	display: block;
         }
      </style>
   </head>
   <body>
      <div class="container">
         <!-- Header -->
         <div class="header">
            <img src="/images/uFYNVaPt6dz1PH6tZ4vfdyOnKS.png" alt="Bluey" class="logo" />
            <ul class="nav">
               <li><a href="/">Home</a></li>
               <li><a href="/watch">Watch</a></li>
               <li><a href="/music">Music</a></li>
               <li><a href="/audiobooks">Audio Books</a></li>
               <li><a href="/download">App</a></li>
               <li>
                  <button class="darkmode-toggle" id="darkToggle" title="Toggle dark mode" aria-label="Toggle dark mode">
                     <svg class="sun" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/>
                        <g>
                           <line x1="12" y1="1" x2="12" y2="3"/>
                           <line x1="12" y1="21" x2="12" y2="23"/>
                           <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                           <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                           <line x1="1" y1="12" x2="3" y2="12"/>
                           <line x1="21" y1="12" x2="23" y2="12"/>
                           <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                           <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </g>
                     </svg>
                     <svg class="moon" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                     </svg>
                  </button>
               </li>
            </ul>
         </div>
         <!-- Main Content -->
         <div class="main">
            <!-- Left: Player & Landscape Description -->
            <div class="main-left">
               <div class="player-wrapper">
                  <div id="player"></div>
               </div>
               <div id="landscape-description" style="display: none; margin-top: 10px; background-color: rgba(0,0,0,0.8); color: #fff; padding: 10px; border-radius: 10px;"></div>
            </div>
            <!-- Right: Seasons, Episodes & Overlay -->
            <div class="main-right">
               <div id="content">
                  <div id="seasons-container">
                     <div id="seasons"></div>
                     <button id="shuffle-button" onclick="toggleShuffleMode()">
                        <svg id="shuffle-icon"
                           width="24" height="24"
                           viewBox="0 0 24 24"
                           fill="none"
                           xmlns="http://www.w3.org/2000/svg"
                           style="vertical-align:middle; border-radius:8px; transition:color 0.2s, background 0.2s, box-shadow 0.2s;">
                           <polyline points="16 3 21 3 21 8" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                           <line x1="4" y1="20" x2="21" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                           <polyline points="21 16 21 21 16 21" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                           <line x1="15" y1="15" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                     </button>
                     <select id="language-select" onchange="setLanguage(this.value, player.getCurrentTime())">
                        <option value="4">Arabic</option>
                        <option value="1" selected>English</option>
                        <option value="3">Malay</option>
                        <option value="5">Tagalog</option>
                     </select>
                     <button id="info-button" onclick="showInfo()">Info</button>
                  </div>
                  <ul id="episodes"></ul>
                  <div class="overlay" id="overlay">
                     <div class="overlay-content">
                        <img id="overlay-image" alt="Episode Thumbnail" />
                        <div class="overlay-content-text">
                           <h2 id="overlay-episode-number"></h2>
                           <h2 id="overlay-title"></h2>
                           <p id="overlay-description"></p>
                           <button id="download-button" onclick="downloadEpisode()">Download</button>
                        </div>
                     </div>
                     <div class="close-overlay" onclick="closeOverlay()">X</div>
                  </div>
               </div>
            </div>
         </div>
         <!-- Scripts -->
         <script src="https://cdn.jsdelivr.net/npm/bitmovin-player@8/bitmovinplayer.js"></script>
         <!-- ---- DARK MODE SCRIPT ---- -->
         <script>
            const themeKey = "bluey-site-theme";
            const root = document.body;
            const darkToggle = document.getElementById("darkToggle");
            function setTheme(dark) {
              if (dark) {
                root.classList.add('dark');
                localStorage.setItem(themeKey, "dark");
              } else {
                root.classList.remove('dark');
                localStorage.setItem(themeKey, "light");
              }
            }
            (() => {
              const saved = localStorage.getItem(themeKey);
              if (saved === "dark" || (!saved && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
                setTheme(true);
              } else {
                setTheme(false);
              }
            })();
            darkToggle.onclick = () => setTheme(!root.classList.contains('dark'));
         </script>
         <script>
            // Global configuration and state variables
            const serverUrl = "https://blueynet.org:443";
            const apiKey = "6b2548952ea2439ea800b8cd3f1072d1";
            const itemId = "11";
            const LANG_STORAGE_KEY = "bluey_watch_selected_language_episodes";

            // Language selection state
            let selectedAudioStreamIndex = 1; // default to English
            let userPreferredLanguage = selectedAudioStreamIndex;
            let userPreferredLanguageBackup = null;
            let fallbackTriggered = false;
            let fallbackEpisodeId = null;
            let fallbackPosition = null;

            // Episode and season state
            let selectedSeason = null;
            let episodes = [];
            let currentEpisodeIndex = -1;
            let episodesCache = {};

            let seasonsList = [];
            let currentSeason = null;
            let currentSeasonIndex = -1;

            // Shuffle state
            let allEpisodes = [];
            let shuffleMode = false;

            // Bitmovin player instance
            let player = null;
            let currentPlaybackRequestId = 0;

            // --- Subtitle persistence ---
            let subsWanted = localStorage.getItem('bluey_subtitle_on') === '1';

            document.addEventListener("DOMContentLoaded", () => {
                const saved = localStorage.getItem(LANG_STORAGE_KEY);
                if (saved !== null) {
                    selectedAudioStreamIndex = parseInt(saved, 10);
                    userPreferredLanguage = selectedAudioStreamIndex;
                    document.getElementById('language-select').value = saved;
                }

                fetchSeasons();

                // Player configuration
                const conf = {
                    key: '1a69b597-a4b2-4bf7-99ba-bd417397c111',
                    cast: {
                        enable: true
                    },
                    remotecontrol: {
                        type: 'googlecast',
                        customReceiverConfig: {
                            receiverStylesheetUrl: 'https://pages.blueynet.org/episodes-chromecast.css'
                        }
                    }
                };
                player = new bitmovin.player.Player(document.getElementById('player'), conf);

                // ---- Subtitle ON/OFF memory ----
                player.on(bitmovin.player.PlayerEvent.SubtitleChanged, function(e) {
                    subsWanted = !!e.subtitle && e.subtitle.lang === 'en';
                    localStorage.setItem('bluey_subtitle_on', subsWanted ? '1' : '0');
                });

                // Error fallback
                player.on(bitmovin.player.PlayerEvent.Error, (error) => {
                    console.error("Player error detected:", error);
                    if (!fallbackTriggered && selectedAudioStreamIndex != 1) {
                        setTimeout(() => {
                            fallbackTriggered = true;
                            if (episodes && currentEpisodeIndex >= 0) {
                                fallbackEpisodeId = episodes[currentEpisodeIndex].Id;
                            }
                            if (userPreferredLanguage != 1) {
                                userPreferredLanguageBackup = userPreferredLanguage;
                            }
                            fallbackPosition = player.getCurrentTime();
                            player.unload().then(() => {
                                selectedAudioStreamIndex = 1;
                                document.getElementById('language-select').value = "1";
                                setLanguage("1", fallbackPosition);
                            }).catch((e) => {
                                selectedAudioStreamIndex = 1;
                                document.getElementById('language-select').value = "1";
                                setLanguage("1", fallbackPosition);
                            });
                        }, 5000);
                    }
                });

                // Auto-advance & shuffle
                player.on(bitmovin.player.PlayerEvent.PlaybackFinished, () => {
                    if (shuffleMode && allEpisodes.length > 0) {
                        let nextIndex;
                        let currentId = episodes[currentEpisodeIndex]?.Id;
                        do {
                            nextIndex = Math.floor(Math.random() * allEpisodes.length);
                        } while (allEpisodes.length > 1 && allEpisodes[nextIndex].Id === currentId);
                        let episode = allEpisodes[nextIndex];
                        let season = seasonsList.find(s => s.Id === episode.SeasonId);
                        if (season) {
                            currentSeason = season;
                            currentSeasonIndex = seasonsList.indexOf(season);
                            document.querySelectorAll('.season-selector__button').forEach(btn => btn.classList.remove('selected'));
                            const seasonBtn = document.querySelector(`.season-selector__button[data-season-id="${season.Id}"]`);
                            if (seasonBtn) seasonBtn.classList.add("selected");
                            episodes = episodesCache[season.Id] || [];
                            renderEpisodes(episodes);
                            let epIndex = episodes.findIndex(e => e.Id === episode.Id);
                            if (epIndex !== -1) {
                                currentEpisodeIndex = epIndex;
                                playEpisode(episode, epIndex);
                            }
                        }
                        return;
                    }
                    if (currentEpisodeIndex >= 0 && currentEpisodeIndex + 1 < episodes.length) {
                        currentEpisodeIndex++;
                        playEpisode(episodes[currentEpisodeIndex], currentEpisodeIndex);
                    } else if (currentEpisodeIndex >= 0 && currentSeasonIndex < seasonsList.length - 1) {
                        currentSeasonIndex++;
                        currentSeason = seasonsList[currentSeasonIndex];
                        document.querySelectorAll('.season-selector__button').forEach(btn => btn.classList.remove('selected'));
                        const nextSeasonButton = document.querySelector(`.season-selector__button[data-season-id="${currentSeason.Id}"]`);
                        if (nextSeasonButton) nextSeasonButton.classList.add("selected");
                        if (episodesCache[currentSeason.Id]) {
                            episodes = episodesCache[currentSeason.Id];
                            renderEpisodes(episodes);
                            currentEpisodeIndex = 0;
                            playEpisode(episodes[0], 0);
                        } else {
                            fetchEpisodes(currentSeason);
                        }
                    }
                });

                // Empty episode list initially
                document.getElementById('episodes').innerHTML = '';

                window.addEventListener('resize', updateOrientationUI);
                document.addEventListener('DOMContentLoaded', updateOrientationUI);
            });

            function prefetchEpisodes(season) {
                if (!episodesCache[season.Id]) {
                    fetch(`${serverUrl}/emby/Shows/${itemId}/Episodes?SeasonId=${season.Id}&api_key=${apiKey}&Fields=Overview`)
                        .then(response => response.json())
                        .then(data => {
                            episodesCache[season.Id] = data.Items;
                            data.Items.forEach(ep => {
                                if (!allEpisodes.find(e => e.Id === ep.Id)) {
                                    allEpisodes.push(ep);
                                }
                            });
                        })
                        .catch(error => console.error("Error prefetching episodes:", error));
                }
            }

            function fetchSeasons() {
                fetch(`${serverUrl}/emby/Shows/${itemId}/Seasons?api_key=${apiKey}`)
                    .then(response => response.json())
                    .then(seasons => {
                        const seasonsContainer = document.getElementById('seasons');
                        seasonsList = seasons.Items.filter(season => season.SeriesId === itemId);
                        seasonsList.forEach((season, i) => {
                            prefetchEpisodes(season);
                            const seasonBtn = document.createElement("button");
                            seasonBtn.classList.add("season-selector__button");
                            seasonBtn.innerText = `Season ${season.IndexNumber}`;
                            seasonBtn.setAttribute("data-season-id", season.Id);
                            seasonBtn.addEventListener("click", () => {
                                handleSeasonClick(seasonBtn, season, i);
                                if (episodesCache[season.Id]) {
                                    episodes = episodesCache[season.Id];
                                    renderEpisodes(episodes);
                                } else {
                                    fetchEpisodes(season);
                                }
                            });
                            seasonsContainer.appendChild(seasonBtn);
                        });
                    })
                    .catch(error => console.error("Error retrieving seasons:", error));
            }

            function fetchEpisodes(season) {
                fetch(`${serverUrl}/emby/Shows/${itemId}/Episodes?SeasonId=${season.Id}&api_key=${apiKey}&Fields=Overview`)
                    .then(response => response.json())
                    .then(data => {
                        episodesCache[season.Id] = data.Items;
                        episodes = data.Items;
                        data.Items.forEach(ep => {
                            if (!allEpisodes.find(e => e.Id === ep.Id)) {
                                allEpisodes.push(ep);
                            }
                        });
                        renderEpisodes(episodes);
                    })
                    .catch(error => console.error("Error retrieving episodes:", error));
            }

            function handleSeasonClick(button, season, seasonIndex) {
                if (selectedSeason) {
                    selectedSeason.classList.remove("selected");
                }
                selectedSeason = button;
                selectedSeason.classList.add("selected");
                currentSeason = season;
                currentSeasonIndex = seasonIndex;
                currentEpisodeIndex = -1;
            }

            function renderEpisodes(episodes) {
                const episodeList = document.getElementById('episodes');
                episodeList.innerHTML = '';
                episodes.forEach((episode, index) => {
                    const episodeItem = document.createElement("li");
                    episodeItem.innerHTML = `
                        <img src="${serverUrl}/emby/Items/${episode.Id}/Images/Primary?api_key=${apiKey}" alt="Episode Thumbnail">
                        <div>
                            <h2>Episode ${episode.IndexNumber}: ${episode.Name}</h2>
                            <p>${episode.Overview}</p>
                        </div>
                    `;
                    episodeItem.addEventListener("click", () => {
                        currentEpisodeIndex = index;
                        playEpisode(episode, index);
                    });
                    if (currentEpisodeIndex === index) {
                        episodeItem.classList.add("selected");
                    }
                    episodeList.appendChild(episodeItem);
                });
            }

            // PLAY EPISODE FUNCTION, patched for subtitle persistence!
            function playEpisode(episode, index, seekTime) {
                if (fallbackTriggered && fallbackEpisodeId !== episode.Id) {
                    if (userPreferredLanguageBackup && userPreferredLanguageBackup != 1) {
                        selectedAudioStreamIndex = userPreferredLanguageBackup;
                        document.getElementById('language-select').value = userPreferredLanguageBackup.toString();
                        userPreferredLanguage = userPreferredLanguageBackup;
                        userPreferredLanguageBackup = null;
                    }
                    fallbackTriggered = false;
                    fallbackEpisodeId = null;
                }

                document.querySelector('.player-wrapper').style.display = 'block';
                if (player) player.pause();

                currentPlaybackRequestId++;
                const requestId = currentPlaybackRequestId;

                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: `S${episode.ParentIndexNumber}E${episode.IndexNumber}: ${episode.Name}`,
                        artist: "Bluey",
                        album: `Season ${episode.ParentIndexNumber}`,
                        artwork: [{
                            src: `${serverUrl}/emby/Items/${episode.Id}/Images/Primary?api_key=${apiKey}`,
                            sizes: '1920x1080',
                            type: 'image/png'
                        }]
                    });

                    navigator.mediaSession.setActionHandler('previoustrack', () => {
                        if (shuffleMode && allEpisodes.length > 1) {
                            let prevIndex;
                            let currentId = episodes[currentEpisodeIndex]?.Id;
                            do {
                                prevIndex = Math.floor(Math.random() * allEpisodes.length);
                            } while (allEpisodes[prevIndex].Id === currentId);
                            let prevEp = allEpisodes[prevIndex];
                            let season = seasonsList.find(s => s.Id === prevEp.SeasonId);
                            if (season) {
                                currentSeason = season;
                                currentSeasonIndex = seasonsList.indexOf(season);
                                episodes = episodesCache[season.Id] || [];
                                renderEpisodes(episodes);
                                let epIndex = episodes.findIndex(e => e.Id === prevEp.Id);
                                if (epIndex !== -1) {
                                    currentEpisodeIndex = epIndex;
                                    playEpisode(prevEp, epIndex);
                                }
                            }
                        } else if (currentEpisodeIndex > 0) {
                            currentEpisodeIndex--;
                            playEpisode(episodes[currentEpisodeIndex], currentEpisodeIndex);
                        } else if (currentSeasonIndex > 0) {
                            currentSeasonIndex--;
                            currentSeason = seasonsList[currentSeasonIndex];
                            episodes = episodesCache[currentSeason.Id] || [];
                            renderEpisodes(episodes);
                            currentEpisodeIndex = episodes.length - 1;
                            playEpisode(episodes[currentEpisodeIndex], currentEpisodeIndex);
                        }
                    });

                    navigator.mediaSession.setActionHandler('nexttrack', () => {
                        if (shuffleMode && allEpisodes.length > 1) {
                            let nextIndex;
                            let currentId = episodes[currentEpisodeIndex]?.Id;
                            do {
                                nextIndex = Math.floor(Math.random() * allEpisodes.length);
                            } while (allEpisodes[nextIndex].Id === currentId);
                            let nextEp = allEpisodes[nextIndex];
                            let season = seasonsList.find(s => s.Id === nextEp.SeasonId);
                            if (season) {
                                currentSeason = season;
                                currentSeasonIndex = seasonsList.indexOf(season);
                                episodes = episodesCache[season.Id] || [];
                                renderEpisodes(episodes);
                                let epIndex = episodes.findIndex(e => e.Id === nextEp.Id);
                                if (epIndex !== -1) {
                                    currentEpisodeIndex = epIndex;
                                    playEpisode(nextEp, epIndex);
                                }
                            }
                        } else if (currentEpisodeIndex < episodes.length - 1) {
                            currentEpisodeIndex++;
                            playEpisode(episodes[currentEpisodeIndex], currentEpisodeIndex);
                        } else if (currentSeasonIndex < seasonsList.length - 1) {
                            currentSeasonIndex++;
                            currentSeason = seasonsList[currentSeasonIndex];
                            episodes = episodesCache[currentSeason.Id] || [];
                            renderEpisodes(episodes);
                            currentEpisodeIndex = 0;
                            playEpisode(episodes[0], 0);
                        }
                    });
                }

                const timestamp = new Date().getTime();
                fetch(`${serverUrl}/emby/Items/${episode.Id}/PlaybackInfo?api_key=${apiKey}&Fields=MediaSources&t=${timestamp}`)
                    .then(response => response.json())
                    .then(playbackInfo => {
                        if (requestId !== currentPlaybackRequestId) return;
                        const mediaSourceId = playbackInfo.MediaSources[0].Id;
                        const PlaySessionId = playbackInfo.PlaySessionId;
                        const VideoBitRate = playbackInfo.MediaSources[0].MediaStreams[0].BitRate;
                        const AudioBitRate = playbackInfo.MediaSources[0].MediaStreams[1].BitRate;
                        const epname = `S${episode.ParentIndexNumber}E${episode.IndexNumber}: ${episode.Name}`;
                        const progressive = `${serverUrl}/emby/videos/${episode.Id}/stream.mp4?Static=true&api_key=${apiKey}`;
                        const hls = `${serverUrl}/emby/videos/${episode.Id}/master.m3u8?MediaSourceId=${mediaSourceId}&PlaySessionId=${PlaySessionId}&api_key=${apiKey}&VideoCodec=h264&AudioCodec=aac&VideoBitrate=${VideoBitRate}&AudioBitrate=${AudioBitRate}&AudioStreamIndex=${selectedAudioStreamIndex}&TranscodingMaxAudioChannels=2&SegmentContainer=fmp4&MinSegments=2&h264-profile=main`;

                        player.load({
                            title: epname,
                            hls: hls,
                            progressive: progressive,
                            poster: `${serverUrl}/emby/Items/${episode.Id}/Images/Primary?api_key=${apiKey}`
                        }).then(() => {
                            const enSubtitle = {
                                id: "sub1",
                                lang: "en",
                                label: "English",
                                url: `${serverUrl}/emby/Videos/${episode.Id}/${mediaSourceId}/Subtitles/2/0/Stream.vtt?api_key=${apiKey}`,
                                kind: "subtitle"
                            };
                            player.subtitles.add(enSubtitle);

                            // ---- SUBTITLE PERSISTENCE LOGIC HERE ----
                            setTimeout(() => {
                                const subsList = player.subtitles.list();
                                if (subsWanted) {
                                    let idx = subsList.findIndex(sub => sub.lang === 'en');
                                    if (idx !== -1) player.subtitles.set(idx);
                                } else {
                                    if (player.subtitles.current() !== null) player.subtitles.set(null);
                                }
                            }, 500);
                            setTimeout(() => {
                                const current = player.subtitles.current();
                                if (subsWanted && (!current || current.lang !== 'en')) {
                                    let idx = player.subtitles.list().findIndex(sub => sub.lang === 'en');
                                    if (idx !== -1) player.subtitles.set(idx);
                                } else if (!subsWanted && current) {
                                    player.subtitles.set(null);
                                }
                            }, 3000);

                            player.play().then(() => {
                                if (typeof seekTime === "number") {
                                    player.seek(seekTime);
                                    fallbackPosition = null;
                                }
                                showInfo();
                            });
                        });
                    })
                    .catch(error => console.error("Error retrieving playback info:", error));

                const prevSelected = document.querySelector("#episodes li.selected");
                if (prevSelected) prevSelected.classList.remove("selected");
                const selectedEpisodeItem = document.querySelector(`#episodes li:nth-child(${index + 1})`);
                if (selectedEpisodeItem) selectedEpisodeItem.classList.add("selected");

                renderOverlay(episode);
            }

            function renderOverlay(episode) {
                if (window.innerHeight > window.innerWidth) {
                    const overlay = document.getElementById('overlay');
                    const overlayImage = document.getElementById('overlay-image');
                    const overlayTitle = document.getElementById('overlay-title');
                    const overlayDescription = document.getElementById('overlay-description');
                    const overlayEpisodeNumber = document.getElementById('overlay-episode-number');
                    overlayImage.src = `${serverUrl}/emby/Items/${episode.Id}/Images/Primary?api_key=${apiKey}`;
                    overlayEpisodeNumber.innerText = `S${episode.ParentIndexNumber}E${episode.IndexNumber}`;
                    overlayTitle.innerText = episode.Name;
                    overlayDescription.innerText = episode.Overview;
                    overlay.style.display = 'block';
                    const descContainer = document.getElementById('landscape-description');
                    if (descContainer) descContainer.style.display = 'none';
                } else {
                    const descContainer = document.getElementById('landscape-description');
                    descContainer.innerHTML = `
                        <img src="${serverUrl}/emby/Items/${episode.Id}/Images/Primary?api_key=${apiKey}" alt="Episode Thumbnail" style="width:120px; height:auto; float:left; margin-right:15px;">
                        <div style="overflow: hidden;">
                            <h2 style="margin-bottom:10px;">S${episode.ParentIndexNumber}E${episode.IndexNumber}: ${episode.Name}</h2>
                            <p>${episode.Overview}</p>
                            <button id="download-button-landscape" onclick="downloadEpisode()" style="cursor:pointer; color:#ffffff; background-color:#e2793b; padding:10px 20px; border:none; border-radius:5px; font-family:'Hello Headline', sans-serif; margin-top:10px;">Download</button>
                        </div>
                        <div style="clear: both;"></div>
                    `;
                    descContainer.style.display = 'block';
                    document.getElementById('overlay').style.display = 'none';
                }
            }

            function closeOverlay() {
                document.getElementById('overlay').style.display = 'none';
            }

            function showInfo() {
                if (currentEpisodeIndex >= 0 && episodes[currentEpisodeIndex]) {
                    renderOverlay(episodes[currentEpisodeIndex]);
                }
            }

            function downloadEpisode() {
                if (currentEpisodeIndex >= 0 && episodes[currentEpisodeIndex]) {
                    const episode = episodes[currentEpisodeIndex];
                    const downloadUrl = `${serverUrl}/emby/Items/${episode.Id}/Download?api_key=${apiKey}`;
                    window.location.href = downloadUrl;
                }
            }

            function setLanguage(value, seekTime) {
                selectedAudioStreamIndex = parseInt(value, 10);
                userPreferredLanguage = selectedAudioStreamIndex;
                localStorage.setItem(LANG_STORAGE_KEY, value);

                if (episodes.length > 0 && currentEpisodeIndex >= 0) {
                    playEpisode(episodes[currentEpisodeIndex], currentEpisodeIndex, seekTime);
                }
            }

            function updateOrientationUI() {
                const infoButton = document.getElementById('info-button');
                const landscapeDesc = document.getElementById('landscape-description');
                if (window.innerHeight > window.innerWidth) {
                    infoButton.style.display = 'block';
                    if (landscapeDesc) landscapeDesc.style.display = 'none';
                } else {
                    infoButton.style.display = 'none';
                    if (currentEpisodeIndex >= 0 && episodes[currentEpisodeIndex]) {
                        renderOverlay(episodes[currentEpisodeIndex]);
                    }
                }
            }

            document.addEventListener('fullscreenchange', () => {
                if (document.fullscreenElement) {
                    screen.orientation
                        .lock('landscape')
                        .catch(err => {});
                } else {
                    if (screen.orientation.unlock) {
                        screen.orientation.unlock();
                    }
                }
            });

            function toggleShuffleMode() {
                shuffleMode = !shuffleMode;
                const shuffleIcon = document.getElementById('shuffle-icon');
                if (shuffleMode) {
                    shuffleIcon.classList.add('active');
                } else {
                    shuffleIcon.classList.remove('active');
                }
            }
         </script>
      </div>
   </body>
</html>
